#!/usr/bin/env node

var chalk     = require('chalk');
var filepaths = require('node-filepaths');
var program   = require('commander');
var Inspector = require('../lib/inspector');
var reporters = require('../lib/reporters');

var summary, suppliedPaths, paths, inspector, reporterType, reporter;

summary = "  Duplicate code and structure detection. By default, the\n" +
          "  tool is ran using the following options:\n" +
          "  jsinspect -f 0 -t 20 -i fn,var -l bool,int,float,string\n\n" +
          "  Available identifier types for matching consist of both\n" +
          "  variables and functions. The following literals can also\n" +
          "  be specified: bool, int, float, and string.";

program
  .version(require('../package.json').version)
  .usage("[options] <paths ...>\n\n" + summary)
  .option('-f, --fuzzy <number>',
    'max distance for fuzzy matching (default: 0)', parseInt)
  .option('-t, --threshold <number>',
    'minimum size of nodes (default: 20)', parseInt)
  .option('-i, --identifiers <types>',
    'match identifiers (default: fn,var)')
  .option('-l, --literals <types>',
    'match literals (default: bool,int,float,string)')
  .option('-I, --no-identifiers', 'disable enforcing matching identifiers')
  .option('-L, --no-literals', 'disable enforcing matching literals')
  .option('-D, --no-diff', 'disable 2-way diffs')
  .option('-C, --no-color', 'disable colors')
  // .option('-r, --reporter [default|json]', 'specify the reporter to use')
  .parse(process.argv);

// Assume all unconsumed arguments are paths
suppliedPaths = program.args || [];
if (!suppliedPaths.length) {
  console.log('Please provide a list of filenames or directories');
  process.exit(0);
}

// chalk doesn't support short flags by default
if (!program.color) {
  chalk.enabled = false;
}

try {
  paths = filepaths.getSync(suppliedPaths, {
    suffix: '.js',
    ignore: 'node_modules'
  });
} catch(e) {
  console.log(e.message);
  process.exit(3);
}

if (!paths.length) {
  console.log('No .js files found in the list of paths');
  process.exit(0);
}

var inspector = new Inspector(paths, {
  distance:    program.fuzzy,
  threshold:   program.threshold,
  diff:        program.diff,
  identifiers: program.identifiers,
  literals:    program.literals
});

// Retrieve the requested reporter
reporterType = reporters[program.reporter] || reporters.default;
reporter = new reporterType(inspector, program.diff);

try {
  process.exit(inspector.run());
} catch(err) {
  console.log(err);
  process.exit(1);
}
